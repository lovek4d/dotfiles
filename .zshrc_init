# autocomplete (must be before sourcing files that use compdef)
if command -v brew >/dev/null 2>&1; then
  FPATH="$(brew --prefix)/share/zsh/site-functions:${FPATH}"
fi
autoload -Uz promptinit && promptinit
autoload -Uz compinit && compinit

# source others
source $HOME/dev/dotfiles/.zshrc_git
source $HOME/dev/dotfiles/.zshrc_tmux
source $HOME/dev/dotfiles/.zshrc_funcs
source $HOME/dev/dotfiles/.zshrc_claude

# general
z() {
  cat <<'EOF'
zshrc aliases:
  general
    dev          cd ~/dev
    python       python3
    wdvenv       source .venv/bin/activate
    docker_prune docker system prune -a --volumes
  dotfiles
    zinit  install/upgrade all deps
    zpl    git pull dotfiles + source
  zshrc
    zvim   edit .zshrc
    zsrc   source .zshrc
    zup    zvim + zsrc
  misc
    redact-json  redact JSON from clipboard
  help
    g      git aliases
    t      tmux aliases
    c      claude aliases
EOF
}

# bootstrap
zinit() {
  # xcode command line tools
  if ! xcode-select -p >/dev/null 2>&1; then
    echo "=== xcode command line tools ==="
    xcode-select --install
    echo "re-run zinit after xcode tools finish installing"
    return 0
  fi

  # homebrew
  if ! command -v brew >/dev/null 2>&1; then
    echo "=== installing homebrew ==="
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    eval "$(/opt/homebrew/bin/brew shellenv)"
  fi

  echo "=== brew packages ==="
  local pkgs=(git fzf tmux nvm python@3 claude-code colima docker)
  brew install "${pkgs[@]}"
  brew upgrade "${pkgs[@]}"

  # nvm needs ~/.nvm dir
  mkdir -p "$HOME/.nvm"

  echo "=== done ==="
  echo "note: run 'colima start' to start the docker runtime"
}

alias dev='cd ~/dev'

# python basics
alias python='python3'
alias wdvenv='source .venv/bin/activate'

# nvm + autocomplete
export NVM_DIR="$HOME/.nvm"
[ -s "/opt/homebrew/opt/nvm/nvm.sh" ] && \. "/opt/homebrew/opt/nvm/nvm.sh"
[ -s "/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm" ] && \. "/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm"

# dotfiles
alias zpl='git -C ~/dev/dotfiles pull && source ~/.zshrc'

# zshrc utils
alias zvim='${EDITOR:-vim} ~/.zshrc'
alias zsrc='source ~/.zshrc'
alias zup='zvim && zsrc'

# docker
alias docker_prune='docker system prune -a --volumes'

# brew shell init
eval "$(/opt/homebrew/bin/brew shellenv)"
